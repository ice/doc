<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" type="text/css" href="../../../asset/static/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="../../../asset/static/css/tomorrow.min.css" id="tomorrow" />
        <link rel="stylesheet" type="text/css" href="../../../asset/static/css/tomorrow-night.min.css" id="tomorrow-night" disabled />
        <link rel="stylesheet" type="text/css" href="../../../asset/static/css/style.css" />
    </head>
    <body>
        <header class="navbar navbar-default navbar-fixed-top">
            <div id="top-bar" class="container-fluid">
                <div id="top-left" class="navbar-header">
                    <a href="../../../index.html" class="navbar-brand">
                                                    ice Documentation <span class="version">v1.4.0</span>
                                            </a>
                </div>
                <div id="top-right" class="collapse navbar-collapse">

                </div>
            </div>
        </header>
        <div id="body" class="container-fluid">
            <div class="row">
                <div id="body-left" class="col-lg-3 col-sm-4">
                    <div class="header-search">
                        <input class="search-box form-control" placeholder="Search for a class or namespace " type="text" />
                        <div id="menu-wrapper">
                        </div>
                    </div>
                </div>
                <div id="body-right" class="col-lg-9 col-sm-8">
                    <div class="content">
                        
<div>
    
    <ul class="breadcrumb">
        
        <li><a href="../../../index.html">Home</a></li>
        
                <li><a href="../../../classes.html">Classes</a></li>
                <li><a href="../../../class/Ice/Mvc/Route.html">Ice\Mvc\Route</a></li>
                <li><a >Source</a></li>
                
    </ul>
    
</div>
<div class="class-header source clearfix">
    
    <div class="access-buttons pull-right">
        <a class="zep-button btn btn-default" href="../../../class/Ice/Mvc/Route.html">Class</a>

                <a class="zep-button btn btn-default" href="https://github.com/ice/framework/tree/dev/ice/mvc/route.zep">Github</a>
            </div>
    
    <div class="class-full-name">
        
        <span class="class-type">Class</span>
        
                <span class="namespace-piece">
            <a href="../../../namespace/Ice.html">Ice</a>
        </span>
                <span class="namespace-piece">
            <a href="../../../namespace/Ice/Mvc.html">Mvc</a>
        </span>
                <h1 class="class-name">Route</h1>
    </div>
    
</div>


<pre class="zephir-source-file"><code>
namespace Ice\Mvc;

use Ice\Di;
use Ice\Exception;

/**
 * This class represents every route added to the router.
 *
 * @package     Ice/Router
 * @category    Component
 * @author      Ice Team
 * @copyright   (c) 2014-2018 Ice Team
 * @license     http://iceframework.org/license
 */
class Route
{

    // Route URI string
    protected routeUri = &quot;&quot;;

    // Regular expressions for route keys
    protected regexMap = [];

    // Compiled regex cache
    protected routeRegex;

    // Regular expressions for route keys
    protected defaults = [&quot;action&quot;: &quot;index&quot;] { get, set };

    protected method { get };
    protected error { get };

    // Defines the pattern of a {placeholder}
    const REGEX_KEYWORD = &quot;\{([a-zA-Z0-9_]++)\}&quot;;

    // What can be part of a {placeholder} value
    const REGEX_PLACEHOLDER = &quot;[^/.,;?\n]++&quot;;

    // What must be escaped in the route regex
    const REGEX_ESCAPE = &quot;[.\\+*?^$=!|]&quot;;

    /**
     * Constructs a route. Each {key} will be translated to a regular expression 
     * using a default regular expression pattern. You can override the default pattern
     * by providing a pattern for the key:
     *
     * &lt;pre&gt;&lt;code&gt;
     *     // This route will only match when {id} is a digit
     *     new Route(&quot;/blog/{action}/{id}&quot;, [&quot;id&quot; =&gt; &quot;\d+&quot;], [&apos;GET&apos;, &apos;POST&apos;]);
     *
     *     // This route will match when {path} is anything
     *     new Route(&quot;/{path}&quot;, [&quot;path&quot; =&gt; &quot;.*&quot;]);
     * &lt;/code&gt;&lt;/pre&gt;
     *
     * It is also possible to create optional segments by using parentheses in
     * the URI definition:
     *
     * &lt;pre&gt;&lt;code&gt;
     *     // This is the standard default route, and no keys are required
     *     new Route(&apos;/{module}[/{controller}[/{action}[/{id}[/params]]]]&apos;);
     *
     *     // This route only requires the {file} key
     *     new Route(&apos;[/{path}/]{file}[.{ext}]&apos;, [&apos;path&apos; =&gt; &apos;.*&apos;, &apos;ext&apos; =&gt; &apos;\w+&apos;]);
     * &lt;/code&gt;&lt;/pre&gt;
     *
     * &lt;pre&gt;&lt;code&gt;
     *     $route = new Route($uri, $regex, [&apos;GET&apos;, &apos;POST&apos;]);
     * &lt;/code&gt;&lt;/pre&gt;
     *
     * @param string uri Route URI pattern
     * @param array regexMap Key patterns map
     * @param mix method Request method limitation, * for no limit or an array of methods
     */
    public function __construct(string uri = null, array! regexMap = null, var method = &quot;*&quot;)
    {
        var regex, search, replace, key, value;

        if uri === null {
            // Assume the route is from cache
            return;
        }

        // Store the URI that this route will match
        let this-&gt;routeUri = uri;

        if !empty regexMap {
            let this-&gt;regexMap = regexMap;
        }

        if empty method {
            let this-&gt;method = &quot;*&quot;;
        } else {
            if typeof method == &quot;array&quot; {
                let this-&gt;method = array_map(&quot;strtoupper&quot;, method);
            } else {
                let this-&gt;method = strtoupper(method);
            }
        }

        // The URI should be considered literal except for keys and optional parts
        // Escape everything preg_quote would escape except for : [ ] { }
        let regex = preg_replace(&quot;#&quot; . self::REGEX_ESCAPE . &quot;#&quot;, &quot;\\\\$0&quot;, this-&gt;routeUri);

        if strpos(regex, &quot;[&quot;) !== false {
            // Make optional parts of the URI non-capturing and optional
            let regex = str_replace([&quot;[&quot;, &quot;]&quot;], [&quot;(?:&quot;, &quot;)?&quot;], regex);
        }

        // Insert default regex for keys
        let regex = str_replace([&quot;{&quot;, &quot;}&quot;], [&quot;(?P&lt;&quot;, &quot;&gt;&quot; . self::REGEX_PLACEHOLDER . &quot;)&quot;], regex);

        if !empty this-&gt;regexMap {
            let search = [], replace = [];
            for key, value in this-&gt;regexMap {
                let search[]  = &quot;&lt;&quot; . key . &quot;&gt;&quot; . self::REGEX_PLACEHOLDER,
                    replace[] = &quot;&lt;&quot; . key . &quot;&gt;&quot; . value;
            }
            // Replace the default regex with the user-specified regex
            let regex = str_replace(search, replace, regex);
        }

        // Store the compiled regex locally
        let this-&gt;routeRegex = &quot;#^&quot; . regex . &quot;$#uD&quot;;
    }

    /**
     * Tests if the route matches a given URI and method.
     *
     * &lt;pre&gt;&lt;code&gt;
     *     // Params: controller = blog, action = edit, id = 10
     *     $params = route-&gt;matches(&quot;/blog/edit/10&quot;);
     * &lt;/code&gt;&lt;/pre&gt;
     *
     * @param string URI to match
     * @param string method
     * @return array|false|null Routed parameters, method not allowed or no match
     */
    public function matches(string uri, string method = &quot;*&quot;)
    {
        var params, key, value, matches = [];

        if !this-&gt;checkMethod(method) {
            return false;
        }

        if !preg_match(this-&gt;routeRegex, uri, matches) {
            // NOT FOUND
            return null;
        }

        let params = this-&gt;defaults;

        for key, value in matches {
            if is_int(key) || value === &quot;&quot; {
                continue;
            }
            let params[key] = value;
        }

        return params;
    }

    /**
     * Tests if the route allows a given method.
     *
     * @param string method
     * @return boolean
     */
    public function checkMethod(string method)
    {
        if this-&gt;method != &quot;*&quot; &amp;&amp; method != &quot;*&quot; {
            if !empty method {
                let method = strtoupper(method);
            }
            // For HEAD requests, attempt fallback to GET
            if method === &quot;HEAD&quot; {
                let method = &quot;GET&quot;;
            }
            if typeof this-&gt;method == &quot;string&quot; &amp;&amp; method != this-&gt;method
                || typeof this-&gt;method == &quot;array&quot; &amp;&amp; !in_array(method, this-&gt;method) {
                // METHOD NOT ALLOWED
                return false;
            }
        }
        return true;
    }

    /**
     * Generates a URI for the current route based on the parameters given. (AKA. reverse route)
     *
     * &lt;pre&gt;&lt;code&gt;
     *     // Using the &quot;default&quot; route: /blog/post/10
     *     $uri = $route-&gt;uri([&quot;controller&quot; =&gt; &quot;blog&quot;, &quot;action&quot; =&gt; &quot;post&quot;, &quot;id&quot; =&gt; 10]);
     *     if (!$uri) echo $route-&gt;getError();
     * &lt;/code&gt;&lt;/pre&gt;
     *
     * @param array URI parameters
     * @return string|false
     */
    public function uri(array! params = null)
    {
        var defaults, uri, param, search, key, replace, matches = [];

        let uri = this-&gt;routeUri,
            defaults = this-&gt;defaults;

        if strpos(uri, &quot;{&quot;) === false &amp;&amp; strpos(uri, &quot;[&quot;) === false {
            // This is a static route, no need to replace anything
            return uri;
        }

        if !empty params {
            let defaults = array_merge(defaults, params);
        }

        while preg_match(&quot;#\[[^[\]]++\]#&quot;, uri, matches) {
            // Search for the matched value
            let search = matches[0];

            // Remove the parenthesis from the match as the replace
            let replace = substr(search, 1, -1);

            while preg_match(&quot;#&quot; . self::REGEX_KEYWORD . &quot;#&quot;, replace, matches) {
                let key = matches[0],
                    param = matches[1];

                if isset defaults[param] {
                    // Replace the key with the parameter value
                    let replace = str_replace(key, defaults[param], replace);
                } else {
                    // This group has missing parameters
                    let replace = &quot;&quot;;
                    break;
                }
            }
            // Replace the group in the URI
            let uri = str_replace(search, replace, uri);
        }

        while preg_match(&quot;#&quot; . self::REGEX_KEYWORD . &quot;#&quot;, uri, matches) {
            let key = matches[0],
                param = matches[1];

            if !isset defaults[param] {
                // Ungrouped parameters are required
                let this-&gt;error = &quot;Required route parameter not passed: &quot; . param;
                return false;
            }

            let uri = str_replace(key, defaults[param], uri);
        }

        // Trim all extra slashes from the URI
        return preg_replace(&quot;#//+#&quot;, &quot;/&quot;, rtrim(uri, &quot;/&quot;));
    }
}
</code></pre>                    </div>
                </div>
            </div>
        </div>

        <script src="../../../asset/static/js/jquery.min.js"></script>
        <script src="../../../asset/static/js/bootstrap.min.js"></script>
        <script src="../../../asset/static/js/highlight.pack.js"></script>
        <script src="../../../asset/static/js/jquery.slimscroll.min.js"></script>
        <script src="../../../asset/api_definition.js"></script>

        <script>var ZepCurrentPath = '../../../'</script>
        <script src="../../../asset/static/js/script.js"></script>
        <script type="text/javascript">
            $(window).on("load resize", function() {
                $('#menu-wrapper').slimscroll({ height: $(window).height() - 100, size: '3px' });
            });
        </script>
        <script type="text/javascript">
            $(document).ready(function() { $('pre code').each(function(i, block) { hljs.highlightBlock(block); }); });
            if ($('.zephir-source-file').length) {
                $('link[id]').each(function(i, link) {
                    link.disabled = (link.id != 'tomorrow-night');
                });
            }
        </script>
            </body>
</html>