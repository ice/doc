<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" type="text/css" href="../../../asset/static/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="../../../asset/static/css/tomorrow.min.css" id="tomorrow" />
        <link rel="stylesheet" type="text/css" href="../../../asset/static/css/tomorrow-night.min.css" id="tomorrow-night" disabled />
        <link rel="stylesheet" type="text/css" href="../../../asset/static/css/style.css" />
    </head>
    <body>
        <header class="navbar navbar-default navbar-fixed-top">
            <div id="top-bar" class="container-fluid">
                <div id="top-left" class="navbar-header">
                    <a href="../../../index.html" class="navbar-brand">
                                                    ice Documentation <span class="version">v1.4.0</span>
                                            </a>
                </div>
                <div id="top-right" class="collapse navbar-collapse">

                </div>
            </div>
        </header>
        <div id="body" class="container-fluid">
            <div class="row">
                <div id="body-left" class="col-lg-3 col-sm-4">
                    <div class="header-search">
                        <input class="search-box form-control" placeholder="Search for a class or namespace " type="text" />
                        <div id="menu-wrapper">
                        </div>
                    </div>
                </div>
                <div id="body-right" class="col-lg-9 col-sm-8">
                    <div class="content">
                        
<div>
    
    <ul class="breadcrumb">
        
        <li><a href="../../../index.html">Home</a></li>
        
                <li><a href="../../../classes.html">Classes</a></li>
                <li><a href="../../../class/Ice/Mvc/Router.html">Ice\Mvc\Router</a></li>
                <li><a >Source</a></li>
                
    </ul>
    
</div>
<div class="class-header source clearfix">
    
    <div class="access-buttons pull-right">
        <a class="zep-button btn btn-default" href="../../../class/Ice/Mvc/Router.html">Class</a>

                <a class="zep-button btn btn-default" href="https://github.com/ice/framework/tree/dev/ice/mvc/router.zep">Github</a>
            </div>
    
    <div class="class-full-name">
        
        <span class="class-type">Class</span>
        
                <span class="namespace-piece">
            <a href="../../../namespace/Ice.html">Ice</a>
        </span>
                <span class="namespace-piece">
            <a href="../../../namespace/Ice/Mvc.html">Mvc</a>
        </span>
                <h1 class="class-name">Router</h1>
    </div>
    
</div>


<pre class="zephir-source-file"><code>
namespace Ice\Mvc;

use Ice\Di;
use Ice\Exception;

/**
 * Router is the standard framework router. Routing is the process of taking a URI endpoint and decomposing it into
 * parameters to determine which module, controller, and action of that controller should receive the request.
 *
 * @package     Ice/Router
 * @category    Component
 * @author      Ice Team
 * @copyright   (c) 2014-2018 Ice Team
 * @license     http://iceframework.org/license
 */
class Router
{
    // list of route objects
    protected routes = [] { get };

    // the name of current matched route after handle()
    protected route = &quot;default&quot;;

    protected method { get };
    protected module { get };
    protected handler { get };
    protected action { get };
    protected params = [] { get };
    protected silent = false { get, set };

    // default module
    protected defaultModule = &quot;default&quot; { get, set };

    // default handler
    protected defaultHandler = &quot;index&quot; { get, set };

    // default action
    protected defaultAction = &quot;index&quot; { get, set };

    /**
     * Stores a named route and returns it.
     *
     * &lt;pre&gt;&lt;code&gt;
     *     $router-&gt;addRoute(&quot;default&quot;, &quot;[/{controller}[/{action}[/{id}]]]&quot;)
     *         -&gt;setDefaults([&quot;controller&quot; =&gt; &quot;hello&quot;]);
     * &lt;/code&gt;&lt;/pre&gt;
     *
     * @param string route name
     * @param string URI pattern
     * @param array regex patterns for route keys
     * @param mix method Request method limitation, * for no limit or an array of methods
     * @return object self
     */
    public function addRoute(string name, string uri, array regex = null, var method = &quot;*&quot;)
    {
        let this-&gt;routes[name] = new Route(uri, regex, method);

        return this-&gt;routes[name];
    }

    /**
     * Retrieves a named route or the current matched route.
     *
     * &lt;pre&gt;&lt;code&gt;
     *     $route = $router-&gt;getRoute(&quot;default&quot;);
     * &lt;/code&gt;&lt;/pre&gt;
     *
     * @param   string route name
     * @return  Route|null
     */
    public function getRoute(string name = null)
    {
        var n = name;
        
        if n === null {
            let n = this-&gt;route;
        }

        return isset this-&gt;routes[n] ? this-&gt;routes[n] : null;
    }

    /**
     * Get the name of a route.
     *
     * @param   object Route instance
     * @return  string
     */
    public function getRouteName(&lt;Route&gt; route)
    {
        return array_search(route, this-&gt;routes);
    }

    /**
     * Saves or loads the route cache.
     *
     * &lt;pre&gt;&lt;code&gt;
     *     if (! $router-&gt;cache()) {
     *         // set routes
     *         $router-&gt;addRoute(&quot;default&quot;, &quot;[/{controller}[/{action}[/{id}]]]&quot;);
     *         // cache routes
     *         $router-&gt;cache($filePath);
     *     }
     * &lt;/code&gt;&lt;/pre&gt;
     *
     * @param   string file Cache the current routes to the file
     * @return  self|boolean when saving routes or loading routes
     */
    public function cache(string file = null)
    {
        if file {
            // Cache all defined routes
            file_put_contents(file, &quot;&lt;?php return &quot; . var_export(this-&gt;routes, true) . &quot;;&quot;);
            return true;
        }

        if file_exists(file) {
            let this-&gt;routes = require file;
            // Routes were cached
            return true;
        }

        // Routes were not cached
        return false;
    }

    /**
     * Set defaults values
     *
     * &lt;pre&gt;&lt;code&gt;
     *     $route-&gt;defaults([&quot;controller&quot; =&gt; &quot;hello&quot;, &quot;action&quot; =&gt; &quot;world&quot;]);
     * &lt;/code&gt;&lt;/pre&gt;
     *
     * @param array defaults values
     * @return self
     */
    public function defaults(array! defaults)
    {
        var module, handler, action;

        if fetch module, defaults[&quot;module&quot;] {
            let this-&gt;defaultModule = module;
        }

        if fetch handler, defaults[&quot;controller&quot;] {
            let this-&gt;defaultHandler = handler;
        }

        if fetch action, defaults[&quot;action&quot;] {
            let this-&gt;defaultAction = action;
        }

        return this;
    }

    /**
     * Set an array of route rules.
     * httpMethod: *|null - no limit, GET, POST, PUT or PATCH
     * URI pattern: [] wrap for optional, {} wrap for regex placeholder key
     * regex: an associate array placeholder key and regex limitation pattern
     * defaults: default options for the module, handler and action
     *
     * &lt;pre&gt;&lt;code&gt;
     *     // the rule format: [&apos;name&apos; =&gt; [&quot;httpMethod&quot;, &quot;URI pattern&quot;, &quot;regex&quot;, &quot;defaults&quot;]]
     *     $route-&gt;setRoutes([
     *         [&quot;default&quot; =&gt; [&quot;POST&quot;, &quot;/{controller}[.ext]&quot;, [&quot;controller&quot; =&gt; &quot;[a-z]+&quot;, &quot;ext&quot; =&gt; &quot;(?:htm|html)&quot;]]]
     *     ]);
     * &lt;/code&gt;&lt;/pre&gt;
     *
     * @param array routes Route rules
     * @return self
     */
    public function setRoutes(array! routes = null)
    {
        var name, option, route, regex, defaults;

        if empty routes {
            // Set default routes
            let routes = [
                [&quot;*&quot;, &quot;[/{controller}[/{action}[/{id}[/{param}]]]]&quot;, [&quot;controller&quot;:&quot;\w+&quot;, &quot;action&quot;:&quot;\w+&quot;]]
            ];
        }

        for name, option in routes {
            if !fetch regex, option[2] {
                let regex = [];
            }
            let route = this-&gt;addRoute(name, option[1], regex, option[0]);
            if fetch defaults, option[3] &amp;&amp; typeof defaults == &quot;array&quot; {
                route-&gt;setDefaults(defaults);
            }
        }

        return this;
    }

    /**
     * Handles routing information.
     *
     * @param string method
     * @param string uri
     * @return mixed
     */
    public function handle(string method = null, string uri = null)
    {
        var name, route, params, matches, response;

        // Remove trailing slashes from the URI
        let uri = uri == &quot;/&quot; ? &quot;/&quot; : rtrim(uri, &quot;/&quot;),
            matches = null;

        for name, route in this-&gt;routes {
            let params = route-&gt;matches(uri, method);
            if !empty params {
                let this-&gt;route = name,
                    this-&gt;method = method;

                if isset params[&quot;module&quot;] {
                    let this-&gt;module = params[&quot;module&quot;];
                } else {
                    let this-&gt;module = this-&gt;defaultModule;
                }

                if isset params[&quot;controller&quot;] {
                    let this-&gt;handler = params[&quot;controller&quot;];
                } else {
                    let this-&gt;handler = this-&gt;defaultHandler;
                }

                if isset params[&quot;action&quot;] {
                    let this-&gt;action = params[&quot;action&quot;];
                } else {
                    let this-&gt;action = this-&gt;defaultAction;
                }

                // These are accessible as public vars and can be overloaded
                unset params[&quot;controller&quot;];
                unset params[&quot;action&quot;];
                unset params[&quot;module&quot;];

                // Params cannot be changed once matched
                let this-&gt;params = params;

                return [
                    &quot;module&quot;: this-&gt;module,
                    &quot;handler&quot;: this-&gt;handler,
                    &quot;action&quot;: this-&gt;action,
                    &quot;params&quot;: this-&gt;params
                ];
            } elseif params === false {
                // method not allowed
                let matches = false;
            }
        }

        if this-&gt;silent {
            // 404 Not Found, 405 Method Not Allowed
            let response = Di::$fetch()-&gt;get(&quot;response&quot;),
                matches = matches === null ? 404 : 405;

            return response-&gt;setStatus(matches)
                -&gt;setBody(response-&gt;getMessage(matches));
        }

        throw new Exception([
            matches === null
                ? &quot;Unable to find a route to match the URI: %s&quot;
                : &quot;Request method not supported by that resource: %s&quot;,
            uri
        ]);
    }

    /**
     * Get route matched by uri and method.
     *
     * @param string uri
     * @param string method
     * @return Route|false|null
     */
    public function match(string uri = null, string method = null)
    {
        var name, route, params, matches;

        // Remove trailing slashes from the URI
        let uri = uri == &quot;/&quot; ? &quot;/&quot; : rtrim(uri, &quot;/&quot;),
            matches = null;

        for name, route in this-&gt;routes {
            let params = route-&gt;matches(uri, method);
            if !empty params {
                return route;
            } elseif params === false {
                // method not allowed
                let matches = false;
            }
        }

        return matches;
    }

    /**
     * Generates a URI based on the parameters given. (AKA. reverse route).
     *
     * &lt;pre&gt;&lt;code&gt;
     *     $uri = $router-&gt;uri([&quot;controller&quot; =&gt; &quot;blog&quot;, &quot;action&quot; =&gt; &quot;post&quot;, &quot;param&quot; =&gt; 10]);
     * &lt;/code&gt;&lt;/pre&gt;
     *
     * @param array URI parameters
     * @param string method
     * @return string|null
     */
    public function uri(array! params, string method = &quot;*&quot;)
    {
        var name, route, uri;

        for name, route in this-&gt;routes {
            let uri = route-&gt;uri(params);
            if uri !== false &amp;&amp; route-&gt;checkMethod(method) {
                return uri;
            }
        }

        return null;
    }
}
</code></pre>                    </div>
                </div>
            </div>
        </div>

        <script src="../../../asset/static/js/jquery.min.js"></script>
        <script src="../../../asset/static/js/bootstrap.min.js"></script>
        <script src="../../../asset/static/js/highlight.pack.js"></script>
        <script src="../../../asset/static/js/jquery.slimscroll.min.js"></script>
        <script src="../../../asset/api_definition.js"></script>

        <script>var ZepCurrentPath = '../../../'</script>
        <script src="../../../asset/static/js/script.js"></script>
        <script type="text/javascript">
            $(window).on("load resize", function() {
                $('#menu-wrapper').slimscroll({ height: $(window).height() - 100, size: '3px' });
            });
        </script>
        <script type="text/javascript">
            $(document).ready(function() { $('pre code').each(function(i, block) { hljs.highlightBlock(block); }); });
            if ($('.zephir-source-file').length) {
                $('link[id]').each(function(i, link) {
                    link.disabled = (link.id != 'tomorrow-night');
                });
            }
        </script>
            </body>
</html>