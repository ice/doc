<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" type="text/css" href="../../../../asset/static/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="../../../../asset/static/css/tomorrow.min.css" id="tomorrow" />
        <link rel="stylesheet" type="text/css" href="../../../../asset/static/css/tomorrow-night.min.css" id="tomorrow-night" disabled />
        <link rel="stylesheet" type="text/css" href="../../../../asset/static/css/style.css" />
    </head>
    <body>
        <header class="navbar navbar-default navbar-fixed-top">
            <div id="top-bar" class="container-fluid">
                <div id="top-left" class="navbar-header">
                    <a href="../../../../index.html" class="navbar-brand">
                                                    ice Documentation <span class="version">v1.4.0</span>
                                            </a>
                </div>
                <div id="top-right" class="collapse navbar-collapse">

                </div>
            </div>
        </header>
        <div id="body" class="container-fluid">
            <div class="row">
                <div id="body-left" class="col-lg-3 col-sm-4">
                    <div class="header-search">
                        <input class="search-box form-control" placeholder="Search for a class or namespace " type="text" />
                        <div id="menu-wrapper">
                        </div>
                    </div>
                </div>
                <div id="body-right" class="col-lg-9 col-sm-8">
                    <div class="content">
                        
<div>
    
    <ul class="breadcrumb">
        
        <li><a href="../../../../index.html">Home</a></li>
        
                <li><a href="../../../../classes.html">Classes</a></li>
                <li><a href="../../../../class/Ice/Cli/Websocket/Client.html">Ice\Cli\Websocket\Client</a></li>
                <li><a >Source</a></li>
                
    </ul>
    
</div>
<div class="class-header source clearfix">
    
    <div class="access-buttons pull-right">
        <a class="zep-button btn btn-default" href="../../../../class/Ice/Cli/Websocket/Client.html">Class</a>

                <a class="zep-button btn btn-default" href="https://github.com/ice/framework/tree/dev/ice/cli/websocket/client.zep">Github</a>
            </div>
    
    <div class="class-full-name">
        
        <span class="class-type">Class</span>
        
                <span class="namespace-piece">
            <a href="../../../../namespace/Ice.html">Ice</a>
        </span>
                <span class="namespace-piece">
            <a href="../../../../namespace/Ice/Cli.html">Cli</a>
        </span>
                <span class="namespace-piece">
            <a href="../../../../namespace/Ice/Cli/Websocket.html">Websocket</a>
        </span>
                <h1 class="class-name">Client</h1>
    </div>
    
</div>


<pre class="zephir-source-file"><code>
namespace Ice\Cli\Websocket;

use Ice\Exception;

/**
 * Websocket client.
 *
 * @package     Ice/Cli
 * @category    Component
 * @author      Ice Team
 * @copyright   (c) 2014-2018 Ice Team
 * @license     http://iceframework.org/license
 */
class Client extends Websocket
{

    protected socket = null;
    protected message = null;
    protected tick = null;

    /**
     * Connect to server.
     *
     * @param string address Address to bind to, defaults to `ws://127.0.0.1:8080`
     * @param array headers Optional array of headers to pass when connecting
     * @return self
     */
    public function connect(string address = &quot;ws://127.0.0.1:8080&quot;, var headers = []) -&gt; &lt;self&gt;
    {
        var addr, key, name, value, res, data, matches;

        let addr = parse_url(address);

        if addr === false || !isset addr[&quot;host&quot;] || !isset addr[&quot;port&quot;] {
            throw new Exception(&quot;Invalid address&quot;);
        }

        let this-&gt;socket = fsockopen(
            (isset addr[&quot;scheme&quot;] &amp;&amp; in_array(addr[&quot;scheme&quot;], [&quot;ssl&quot;, &quot;tls&quot;, &quot;wss&quot;]) ? &quot;tls://&quot; : &quot;&quot;) . addr[&quot;host&quot;],
            addr[&quot;port&quot;]
        );

        if this-&gt;socket === false {
            throw new Exception(&quot;Could not connect&quot;);
        }

        let key = this-&gt;generateKey(),
            headers = array_merge(
                this-&gt;normalizeHeaders([
                    &quot;Host&quot;: addr[&quot;host&quot;] . &quot;:&quot; . addr[&quot;port&quot;],
                    &quot;Connection&quot;: &quot;Upgrade&quot;,
                    &quot;Upgrade&quot;: &quot;websocket&quot;,
                    &quot;Sec-Websocket-Key&quot;: key,
                    &quot;Sec-Websocket-Version&quot;: &quot;13&quot;
                ]),
                this-&gt;normalizeHeaders(headers)
            );

        let key = headers[&quot;Sec-Websocket-Key&quot;];

        for name, value in headers {
            let headers[name] = name . &quot;: &quot; . value;
        }

        if !empty addr[&quot;path&quot;] {
            let res = addr[&quot;path&quot;] . (empty addr[&quot;query&quot;] ? &quot;&quot; : &quot;?&quot; . addr[&quot;query&quot;]);
        } else {
            let res = &quot;/&quot;;
        }

        array_unshift(headers, &quot;GET &quot; . res . &quot; HTTP/1.1&quot;);
        this-&gt;sendClear(this-&gt;socket, implode(&quot;\r\n&quot;, headers).&quot;\r\n&quot;);

        let data = this-&gt;receiveClear(this-&gt;socket);

        if !preg_match(&quot;(Sec-Websocket-Accept:\s*(.*)$)mUi&quot;, data, matches) {
            throw new Exception(&quot;Bad response&quot;);
        }

        if trim(matches[1]) !== base64_encode(pack(&quot;H*&quot;, sha1(key . self::magic))) {
            throw new Exception(sprintf(&quot;Bad key `%s` `%s`&quot;, trim(matches[1]), base64_encode(pack(&quot;H*&quot;, sha1(key . self::magic)))));
        }

        return this;
    }

    /**
     * Generate key.
     *
     * @return string
     */
    protected function generateKey() -&gt; string
    {
        var chars, key, length;
        int i = 0;

        let chars = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\&quot;$&amp;/()=[]{}0123456789&quot;,
            key = &quot;&quot;,
            length = strlen(chars) - 1;

        while i &lt; 16 {
            let key .= chars[mt_rand(0, length)],
                i++;
        }

        return base64_encode(key);
    }

    /**
     * Normalize header.
     *
     * @param array headers headers to normalize
     * @return array
     */
    protected function normalizeHeaders(array headers) -&gt; array
    {
        var cleaned, name, value;

        let cleaned = [];

        for name, value in headers {
            if strncmp(name, &quot;HTTP_&quot;, 5) === 0 {
                let name = substr(name, 5);
            }

            if name !== false {
                let name = ucwords(str_replace(
                     [&quot;_&quot;, &quot;-&quot;, &quot; &quot;],
                     [&quot; &quot;, &quot; &quot;, &quot;-&quot;],
                     strtolower(name)
                 ),  &quot;-&quot;),
                    cleaned[name] = value;
            }
        }

        return cleaned;
    }

    /**
     * Send a message to the server.
     *
     * @param string data The data to send
     * @param string opcode The data opcode, defaults to `text`
     * @return boolean Was the send successful
     */
    public function send(string data, string opcode = &quot;text&quot;) -&gt; boolean
    {
        return parent::sendData(this-&gt;socket, data, opcode, true);
    }

    /**
     * Start listening.
     *
     * @return void
     */
    public function run() -&gt; void
    {
        var changed, write, except, socket, message;

        while 1 {
            if isset this-&gt;tick {
                if call_user_func(this-&gt;tick, this) === false {
                    break;
                }
            }

            let changed = [this-&gt;socket],
                write = [],
                except = [];

            if stream_select(changed, null, null, (isset this-&gt;tick ? 0 : null)) &gt; 0 {
                for socket in changed {
                    let message = this-&gt;receive(socket);

                    if message !== false &amp;&amp; isset this-&gt;message {
                        call_user_func(this-&gt;message, message, this);
                    }
                }
            }
            usleep(this-&gt;getParam(&quot;sleep&quot;, 5000));
        }
    }

    /**
     * Set a callback to execute when a message arrives.
     * The callable will receive the message string and the server instance.
     *
     * @param callable callback The callback
     * @return self
     */
    public function onMessage(callable callback) -&gt; &lt;self&gt;
    {
        let this-&gt;message = callback;

        return this;
    }

    /**
     * Set a callback to execute every few milliseconds.
     * The callable will receive the server instance. If it returns boolean `false` the client will stop listening.
     *
     * @param callable callback The callback
     * @return self
     */
    public function onTick(callable callback) -&gt; &lt;self&gt;
    {
        let this-&gt;tick = callback;

        return this;
    }
}
</code></pre>                    </div>
                </div>
            </div>
        </div>

        <script src="../../../../asset/static/js/jquery.min.js"></script>
        <script src="../../../../asset/static/js/bootstrap.min.js"></script>
        <script src="../../../../asset/static/js/highlight.pack.js"></script>
        <script src="../../../../asset/static/js/jquery.slimscroll.min.js"></script>
        <script src="../../../../asset/api_definition.js"></script>

        <script>var ZepCurrentPath = '../../../../'</script>
        <script src="../../../../asset/static/js/script.js"></script>
        <script type="text/javascript">
            $(window).on("load resize", function() {
                $('#menu-wrapper').slimscroll({ height: $(window).height() - 100, size: '3px' });
            });
        </script>
        <script type="text/javascript">
            $(document).ready(function() { $('pre code').each(function(i, block) { hljs.highlightBlock(block); }); });
            if ($('.zephir-source-file').length) {
                $('link[id]').each(function(i, link) {
                    link.disabled = (link.id != 'tomorrow-night');
                });
            }
        </script>
            </body>
</html>